<?xml version="1.0" encoding="UTF-8"?>
<project name="testsrc" basedir="..">
	<!--
		Location of mozilla/js/tests directory
	-->
	<property name="test.library.dir" location="../tests" />
	
	<!--
		Destination to which testing classes should be built
	-->
	<property name="test.classes" value="${build.dir}/test/classes" />
	
	<!--
		Output directory for HTML files generated by jsdriver
	-->
	<property name="test.output" value="${build.dir}/test/output" />
	
	<!--
		Timeout in milliseconds for tests
	-->
	<property name="test.timeout" value="60000" />
	
	<!--
		Maximum heap size for VM executing test cases.
	-->
	<property name="test.vm.mx" value="256m" />
	
	<!--	
		TODO	Currently JUnit is required in order to compile the test code, which ought not be necessary
	-->
	<target name="compile">
		<mkdir dir="${test.classes}" />
		<javac destdir="${test.classes}" debug="true"
			target="${target-jvm}"
			source="${source-level}"
		>
			<classpath>
				<pathelement path="${classes}" />
			</classpath>
			<src path="testsrc" />
		</javac>
		<copy todir="${test.classes}/org/mozilla/javascript">
			<fileset dir="testsrc/org/mozilla/javascript">
				<include name="*.html"/>
			</fileset>
		</copy>
	</target>
	
	<target name="clean">
		<delete dir="${test.classes}" />
	</target>
	
	<target name="junit" depends="compile">
		<junit printsummary="on" fork="true" forkmode="once" maxmemory="${test.vm.mx}" showoutput="true">
			<sysproperty key="mozilla.js.tests" value="${test.library.dir}" />
			<sysproperty key="mozilla.js.tests.timeout" value="${test.timeout}" />
			<classpath>
				<pathelement location="${xbean.jar}"/>
				<pathelement location="${jsr173.jar}"/>
				<pathelement path="${classes}" />
				<pathelement path="${test.classes}" />
			</classpath>
			<test name="org.mozilla.javascript.StandardTests" />
			<formatter type="plain" usefile="false" />
		</junit>
	</target>
	
	<target name="jsdriver" depends="compile">
		<tstamp>
			<format property="test.timestamp" pattern="yyyy.MM.dd.HH.mm.ss" />
		</tstamp>
		<mkdir dir="${test.output}" />
		<java
			fork="true"
			classname="org.mozilla.javascript.JsDriver"
			maxmemory="${test.vm.mx}"
		>
			<classpath>
				<pathelement location="${xbean.jar}"/>
				<pathelement location="${jsr173.jar}"/>
				<pathelement path="${classes}" />
				<pathelement path="${test.classes}" />
			</classpath>
			<arg value="-p" />
			<arg file="${test.library.dir}" />
			<arg value="-f" />
			<arg value="${test.output}/rhino-test-results.${test.timestamp}.html" />
			<arg value="--timeout" />
			<arg value="${test.timeout}" />
		</java>
	</target>
</project>
